{% extends "base.html" %}
{% load render_table from django_tables2 %}
{% load crispy_forms_tags %}
{% block title %}Users for {{ auction }}{% endblock %}
{% load static %}
{% block content %}
  {% include 'auction_ribbon.html' %}
  <small>This is a list of people in your auction.  Click on a name to edit that user.<br></small>
  <div class="dropdown">
    <button class="btn btn-sm btn-info dropdown-toggle" type="button" id="addUserDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <i class="bi bi-person-fill-add"></i> Add user
    </button>
    <div class="dropdown-menu" aria-labelledby="addUserDropdown">
      <a href="#" class="dropdown-item"
         hx-get="/api/auctiontos/{{auction.slug}}/"
         hx-target="#modals-here"
         hx-trigger="click"
         _="on htmx:afterOnLoad wait 10ms then add .show to #modal then add .show to #modal-backdrop">
        <i class="bi bi-person-fill-add"></i> Add single user
      </a>
      <a href="{% url 'bulk_add_users' auction.slug %}" class="dropdown-item"><i class="bi bi-node-plus"></i> Bulk add users</a>
      <div class="dropdown-divider"></div>
      <input type="file" name="csv_file_quick" id="csv_file_quick" accept=".csv" 
             hx-encoding="multipart/form-data" 
             hx-post="{% url 'bulk_add_users' auction.slug %}" 
             hx-swap="outerHTML" 
             hx-target="body" 
             style="display: none;">
      <a href="#" class="dropdown-item" onclick="document.getElementById('csv_file_quick').click(); return false;">
        <i class="bi bi-person-fill-up"></i> Import from CSV
      </a>
      {% if auction.google_drive_link %}
      <div class="dropdown-divider"></div>
      <form method="POST" action="{% url 'sync_google_drive' slug=auction.slug %}" style="display: inline; width: 100%;">
        {% csrf_token %}
        <button type="submit" class="dropdown-item"><i class="bi bi-arrow-repeat"></i> Sync from Google Drive</button>
      </form>
      {% if auction.last_sync_time %}
        <span class="dropdown-item text-muted"><small>Last synced {{ auction.last_sync_time|timesince }} ago</small></span>
      {% endif %}
      {% else %}
      <div class="dropdown-divider"></div>
      <span class="dropdown-item text-muted disabled"><i class="bi bi-arrow-repeat"></i> Sync from Google Drive (not set up)</span>
      {% endif %}
    </div>
  </div>
    <span class="dropdown">
      <button class="btn btn-sm mt-2 mb-2 btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="bi bi-download"></i> Export
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <a href="{% url 'user_list' slug=auction.slug %}" id="user_csv_export" class="dropdown-item"><i class="bi bi-person-fill-down"></i> Users CSV</a>
        <a href="{% url 'compose_email_to_users' slug=auction.slug %}" id="email_all_users" class="dropdown-item"><i class="bi bi-envelope-fill"></i> Email all users</a>
        {% if auction.show_paypal_csv_link %}
          {% if auction.enable_online_payments %}
              <span class="text-muted dropdown-item"><i class="bi bi-paypal"></i> PayPal payments enabled, export not available</span>
          {% else %}
            {% for chunk in auction.paypal_invoice_chunks %}
            <a href="{% url 'paypal_csv' slug=auction.slug chunk=chunk %}" class="dropdown-item"><i class="bi bi-paypal"></i> PayPal Invoice CSV {% if auction.paypal_invoice_chunks|length > 1 %} #{{chunk}}{% endif %}</a>
            {% endfor %}
            {% if not auction.paypal_invoice_chunks|length %}<span class="text-muted dropdown-item"><i class="bi bi-paypal"></i> No PayPal invoices</span>
            {% else %}
            <a href="https://www.paypal.com/invoice/batch" class="dropdown-item"><i class="bi bi-paypal"></i> PayPal Batch Invoice Upload</span>
            {% endif %}
            <a href="/blog/online-payments-suck/" class="dropdown-item"><i class="bi bi-info-circle"></i> PayPal invoice help</a>
          {% endif %}
        {% endif %}
      </div>
    </span>
    {% if not auction.is_online %}<a class="btn btn-sm btn-primary" href='{% url "auction_quick_checkout" slug=auction.slug %}'><i class="bi bi-bag-heart"></i> Quick checkout users</a>{% endif %}
    {% if auction.show_invoice_ready_button %}
    <a href="#" class="btn btn-sm mt-2  mb-2 btn-primary"
    hx-get="{% url 'auction_invoices_ready' auction.slug %}"
    hx-target="#modals-here"
    hx-trigger="click"
    _="on htmx:afterOnLoad wait 10ms then add .show to #modal then add .show to #modal-backdrop"><i class="bi bi-bag-check"></i> Set open invoices to ready</a>
    <a href="#" class="btn btn-sm mt-2  mb-2 btn-primary"
    hx-get="{% url 'auction_invoices_paid' auction.slug %}"
    hx-target="#modals-here"
    hx-trigger="click"
    _="on htmx:afterOnLoad wait 10ms then add .show to #modal then add .show to #modal-backdrop"><i class="bi bi-bag-heart"></i> Set ready invoices to paid</a>
    {% endif %}
    <span class="dropdown">
      <button class="btn btn-sm mt-2 mb-2 btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="bi bi-filter"></i> Filters
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        {% if auction.online_bidding != 'disable' %}
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_no_bid"> <i class="bi bi-cash-coin"></i> Can't bid
        </label>
        {% endif %}
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_no_sell"> <i class="bi bi-exclamation-octagon-fill"></i> Can't sell
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_email_bad"> <i class="bi bi-envelope-exclamation-fill"></i> Only invalid email
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_email_good"> <i class="bi bi-envelope-check-fill"></i> Only verified email
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_duplicate"> <i class="bi bi-people-fill"></i> Possible Duplicate
        </label>
        <span class="text-muted dropdown-item"><small>Users with an invoice that is:</small></span>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_open"> <i class="bi bi-bag"></i> Open
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_ready"> <i class="bi bi-bag-check"></i> Ready
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_paid"> <i class="bi bi-bag-heart"></i> Paid
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_owes_club"> <i class="bi bi-bag-dash"></i> Owes the club
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_club_owes"> <i class="bi bi-bag-plus"></i> Club owes
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_seen"> <i class="bi bi-eye-fill"></i> User has seen
        </label>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_unseen"> <i class="bi bi-eye-slash-fill"></i> User has not seen
        </label>
        {% if auction.is_online %}
        <span class="text-muted dropdown-item"><small>Find problematic users:</small></span>
        <label class="dropdown-item ">
          <input type="checkbox" class="invoice_filter" id="checkbox_sus"> <i class="bi bi-exclamation-circle"></i> Least engagement first
        </label>
        {% endif %}
        <label class="dropdown-item "></label>
          <span class="dropdown-item"><i class="bi bi-patch-plus-fill"></i> <a href='https://github.com/iragm/fishauctions/issues/215'>Suggest a new filter</a></span>
        </label>
      </div>
    </span>
<form class="col-sm-12 mt-2">
  {% crispy filter.form %}
  </form>
  {# Progress indicator #}
  {# <div class="progress"> <div class="indeterminate"></div>      </div>  #}
  {# The actual table #}
  {% render_table table %}
{% endblock %}
{% block extra_js %}
<script type='text/javascript'>pageView();</script>
<script type="text/javascript">
$(document).ready(function(){
  // Initialize tooltips with titles
  $('#user_csv_export').attr('data-bs-title', "This export uses your current filter");
  $('#email_all_users').attr('data-bs-title', "This will compose an email with BCC for filtered users");
  
  // Initialize Bootstrap tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-title]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  $("#id_query").blur(function(){
    var value = this.value;
    var idsToUncheck = [];
    $(".invoice_filter").each(function() {
        var cmd = this.id.replace("checkbox_", "").replace("_", " ");
        var regex = new RegExp("(^|\\s)" + cmd + "(?=\\s|$)", "g");
        if (regex.test(value)) {
            $(this).prop("checked", true);
        } else {
            idsToUncheck.push(this.id);
        }
    });

    // Loop through the list of ids to uncheck and uncheck them all
    idsToUncheck.forEach(function(id) {
        $("#" + id).prop("checked", false);
    });
  });
    $(".invoice_filter").change(function(){
        var cmd = this.id.replace("checkbox_", "").replace("_", " ");
        if($(this).is(":checked")) {
          update_cmd(cmd, true);
        } else {
          update_cmd(cmd, false);
        }
    });
    function update_cmd(cmd, add_cmd) {
      var queryValue = $("#id_query").val();
      var regex = new RegExp("(^|\\s)" + cmd + "(?=\\s|$)", "g");
      queryValue = queryValue.replace(regex, "");
      if (add_cmd) {
        queryValue += " " + cmd;
      }
      $("#id_query").val(queryValue);
      // simulate keystroke to fire off htmx
      document.getElementById("id_query").dispatchEvent(new KeyboardEvent("keyup", {
        bubbles: true,
        cancelable: true,
        })
      );
    }
});
// Helper function to update link href with query parameter
function updateLinkWithQuery(linkId, query) {
  let link = document.getElementById(linkId);
  if (link) {
    let originalHref = link.getAttribute('href').split('?')[0];
    link.setAttribute('href', `${originalHref}?query=${encodeURIComponent(query)}`);
  }
}

// update url to allow bookmarking searches
let queryInput = document.getElementById('id_query');
if (queryInput) {
  queryInput.addEventListener('input', function(event) {
    let query = event.target.value;
    let newUrl = new URL(window.location);
    newUrl.searchParams.set('query', query);
    history.replaceState({}, '', newUrl);
    
    // Update links with the query parameter
    updateLinkWithQuery('user_csv_export', query);
    updateLinkWithQuery('email_all_users', query);
    
    htmx.trigger('#filter-form', 'keyup');
  });
}
</script>
{% endblock %}
